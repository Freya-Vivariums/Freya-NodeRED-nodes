<!--
  Freya Vivarium Control System - Humidity Controller Node HTML
  Copyright (C) 2025 Sanne 'SpuQ' Santens

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->
<script type="text/javascript">
  RED.nodes.registerType('humidity controller',{
    category: 'Freya Vivariums',
    color: "#A2CA6F",
    defaults: {
      name: {value:""},
      deadband: {value: 2.0, required: true, validate: RED.validators.number()},
      minimumHumidity: {value: 0.0, required: true, validate: RED.validators.number()},
      maximumHumidity: {value: 100.0, required: true, validate: RED.validators.number()},
      watchdogTimeout: {value: 60, required: true, validate: RED.validators.number()},
      watchdogSeverity: {value: "warning", required: true}
    },
    inputs:1,
    outputs:2,
    outputLabels:["actuator commands", "status"],
    icon: "font-awesome/fa-tint",
    label: function() {
      return this.name || "Humidity Controller";
    },
    oneditprepare: function() {
      // Validation for deadband
      $("#node-input-deadband").on('input', function() {
        const val = parseFloat($(this).val());
        if (isNaN(val) || val < 0) {
          $(this).addClass('input-error');
        } else {
          $(this).removeClass('input-error');
        }
      });
      
      // Validation for minimum humidity
      $("#node-input-minimumHumidity").on('input', function() {
        const val = parseFloat($(this).val());
        if (isNaN(val) || val < 0 || val > 100) {
          $(this).addClass('input-error');
        } else {
          $(this).removeClass('input-error');
        }
      });
      
      // Validation for maximum humidity
      $("#node-input-maximumHumidity").on('input', function() {
        const val = parseFloat($(this).val());
        const min = parseFloat($("#node-input-minimumHumidity").val());
        if (isNaN(val) || val < 0 || val > 100 || (!isNaN(min) && val <= min)) {
          $(this).addClass('input-error');
        } else {
          $(this).removeClass('input-error');
        }
      });
    }
  });
</script>

<script type="text/html" data-template-name="humidity controller">
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>
  
  <div class="form-row">
    <label for="node-input-deadband"><i class="fa fa-arrows-h"></i> Deadband (%)</label>
    <input type="number" id="node-input-deadband" placeholder="2.0" step="0.1" min="0">
    <div class="form-tips">Dual deadband threshold. Humidifying starts below target-deadband, stops at target. Dehumidifying starts above target+deadband, stops at target.</div>
  </div>
  
  <div class="form-row">
    <label for="node-input-minimumHumidity"><i class="fa fa-thermometer-empty"></i> Minimum Humidity (%)</label>
    <input type="number" id="node-input-minimumHumidity" placeholder="0.0" step="1" min="0" max="100">
    <div class="form-tips">Safety floor - force humidification below this level</div>
  </div>
  
  <div class="form-row">
    <label for="node-input-maximumHumidity"><i class="fa fa-thermometer-full"></i> Maximum Humidity (%)</label>
    <input type="number" id="node-input-maximumHumidity" placeholder="100.0" step="1" min="0" max="100">
    <div class="form-tips">Safety ceiling - force dehumidification above this level</div>
  </div>
  
  <hr/>
  
  <div class="form-row">
    <label for="node-input-watchdogTimeout"><i class="fa fa-clock-o"></i> Watchdog Timeout (seconds)</label>
    <input type="number" id="node-input-watchdogTimeout" placeholder="60" step="1" min="1">
    <div class="form-tips">Time to wait without sensor updates before entering safe open-loop mode</div>
  </div>
  
  <div class="form-row">
    <label for="node-input-watchdogSeverity"><i class="fa fa-exclamation-triangle"></i> Watchdog Severity</label>
    <select id="node-input-watchdogSeverity">
      <option value="warning">Warning</option>
      <option value="error">Error</option>
    </select>
    <div class="form-tips">Severity level emitted when watchdog triggers</div>
  </div>
</script>

<script type="text/html" data-help-name="humidity controller">
  <p>Dual deadband humidity controller with target-centered control zones and safety overrides for vivarium environmental control.</p>
  
  <h3>Input</h3>
  <dl class="message-properties">
    <dt>Target Humidity <span class="property-type">number</span></dt>
    <dd>Target humidity percentage from circadian core or other source</dd>
    
    <dt>Sensor Reading <span class="property-type">number</span></dt>
    <dd>Current humidity reading from environment sensor with <code>msg.topic: "sensor"</code> and <code>msg.payload: number</code></dd>
  </dl>
  
  <h3>Outputs</h3>
  <dl class="message-properties">
    <dt>Output 1: Actuator Commands <span class="property-type">object</span></dt>
    <dd>Commands for actuators: <code>{humidifier: "on/off", dehumidifier: "on/off"}</code></dd>
    
    <dt>Output 2: Status <span class="property-type">object</span></dt>
    <dd>Controller status including state, readings, safety overrides, and deadband</dd>
  </dl>
  
  <h3>Control Logic</h3>
  <ul>
    <li><strong>Humidifying:</strong> Starts when reading < target - deadband, continues until reading reaches target</li>
    <li><strong>Dehumidifying:</strong> Starts when reading > target + deadband, continues until reading reaches target</li>
    <li><strong>Idle:</strong> When at target or within deadband with no prior active state</li>
    <li><strong>Safety Override:</strong> Force humidification below minimum or dehumidification above maximum</li>
  </ul>
  
  <h3>Configuration</h3>
  <ul>
    <li><strong>Deadband:</strong> Half-width around target to prevent oscillation (default: 2.0%)</li>
    <li><strong>Minimum Humidity:</strong> Safety floor for emergency humidification (default: 0%)</li>
    <li><strong>Maximum Humidity:</strong> Safety ceiling for emergency dehumidification (default: 100%)</li>
    <li><strong>Watchdog Timeout:</strong> Time without sensor updates before open-loop mode (default: 60s)</li>
    <li><strong>Watchdog Severity:</strong> Alert level when watchdog triggers (warning/error)</li>
  </ul>
  
  <h3>Watchdog Protection</h3>
  <ul>
    <li><strong>Sensor Monitoring:</strong> Tracks time since last sensor update</li>
    <li><strong>Open-Loop Mode:</strong> Enters safe state (all actuators off) if no sensor feedback within timeout</li>
    <li><strong>Auto Recovery:</strong> Resumes normal control immediately when sensor returns</li>
    <li><strong>Status Alerts:</strong> Emits configurable severity alerts on watchdog trigger</li>
  </ul>
</script>