<script type="text/javascript">
  RED.nodes.registerType('circadian core',{
    category: 'Freya Vivariums',
    color: "#A2CA6F",
    defaults: {
      name: {value:""},
      locationConfig: {value:"", type:"location-config", required:true},
      phaseShift: {value: 0.0, required: true, validate: RED.validators.number()},
      diurnalSwing: {value: 1.0, required: true, validate: RED.validators.number()},
      seasonalSwing: {value: 1.0, required: true, validate: RED.validators.number()},
      tickInterval: {value: 60, required: true, validate: function(v) { return RED.validators.number()(v) && parseInt(v) >= 1; }},
      decimals: {value: 1, required: true, validate: function(v) { return RED.validators.number()(v) && parseInt(v) >= 0 && parseInt(v) <= 4; }}
    },
    inputs:1,
    outputs:2,
    outputLabels:["control", "status"],
    icon: "font-awesome/fa-globe",
    label: function() {
      return this.name || "Circadian Core";
    },
    oneditprepare: function() {
      // Handle diurnal swing dropdown
      $('#node-input-diurnalSwing').on('change', function() {
        if ($(this).val() === 'custom') {
          $('#node-input-diurnalSwing-custom').show();
        } else {
          $('#node-input-diurnalSwing-custom').hide();
        }
      });
      
      // Handle seasonal swing dropdown
      $('#node-input-seasonalSwing').on('change', function() {
        if ($(this).val() === 'custom') {
          $('#node-input-seasonalSwing-custom').show();
        } else {
          $('#node-input-seasonalSwing-custom').hide();
        }
      });
    },
    oneditsave: function() {
      // Save custom values if selected
      if ($('#node-input-diurnalSwing').val() === 'custom') {
        this.diurnalSwing = parseFloat($('#node-input-diurnalSwing-custom').val()) || 1.0;
      } else {
        this.diurnalSwing = parseFloat($('#node-input-diurnalSwing').val()) || 1.0;
      }
      
      if ($('#node-input-seasonalSwing').val() === 'custom') {
        this.seasonalSwing = parseFloat($('#node-input-seasonalSwing-custom').val()) || 1.0;
      } else {
        this.seasonalSwing = parseFloat($('#node-input-seasonalSwing').val()) || 1.0;
      }
    },
    oneditresize: function() {
    }
  });
</script>


<script type="text/html" data-template-name="circadian core">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Circadian Core">
    </div>
    <hr/>
    <div class="form-row">
        <label for="node-input-locationConfig"><i class="fa fa-map-marker"></i> Location Config</label>
        <input type="text" id="node-input-locationConfig">
        <i class="fa fa-info-circle" title="Select a location configuration node that defines geographic and planetary parameters."></i>
    </div>
    <hr/>
    <div class="form-row">
        <label for="node-input-phaseShift"><i class="fa fa-clock-o"></i> Phase Shift (°)</label>
        <input type="number" id="node-input-phaseShift" placeholder="0" step="1" min="-180" max="180">
        <i class="fa fa-info-circle" title="Phase shift in degrees relative to solar cycle. 0° = peak at solar noon, 180° = peak at solar midnight, 30-45° = afternoon temperature lag."></i>
    </div>
    <div class="form-row">
        <label for="node-input-diurnalSwing"><i class="fa fa-sun-o"></i> Diurnal Swing</label>
        <select id="node-input-diurnalSwing">
            <option value="0.3">Minimal (0.3) - deep forest floor, cave entrance</option>
            <option value="0.6">Dampened (0.6) - dense canopy, humid lowland</option>
            <option value="1.0" selected>Normal (1.0) - open woodland, typical habitat</option>
            <option value="1.3">Pronounced (1.3) - scrubland, semi-arid</option>
            <option value="1.6">Extreme (1.6) - exposed rock, desert</option>
            <option value="custom">Custom...</option>
        </select>
        <input type="number" id="node-input-diurnalSwing-custom" placeholder="1.0" step="0.1" min="0" style="display:none; margin-left:10px; width:80px;">
        <i class="fa fa-info-circle" title="Controls how much the environment varies between day and night. Forest species need minimal variation, while desert species experience extreme daily swings."></i>
    </div>
    <div class="form-row">
        <label for="node-input-seasonalSwing"><i class="fa fa-leaf"></i> Seasonal Swing</label>
        <select id="node-input-seasonalSwing">
            <option value="0.2">Minimal (0.2) - tropical species, equatorial habitat</option>
            <option value="0.5">Dampened (0.5) - subtropical, mild seasonal change</option>
            <option value="1.0" selected>Normal (1.0) - temperate, matches latitude</option>
            <option value="1.3">Pronounced (1.3) - continental climate, strong seasons</option>
            <option value="1.6">Extreme (1.6) - extreme continental, harsh winters</option>
            <option value="custom">Custom...</option>
        </select>
        <input type="number" id="node-input-seasonalSwing-custom" placeholder="1.0" step="0.1" min="0" style="display:none; margin-left:10px; width:80px;">
        <i class="fa fa-info-circle" title="Controls how much the environment varies between summer and winter. Tropical species need minimal seasonal variation, while temperate species experience strong seasonal changes."></i>
    </div>
    <div class="form-row">
        <label for="node-input-tickInterval"><i class="fa fa-clock-o"></i> Tick Interval (seconds)</label>
        <input type="number" id="node-input-tickInterval" placeholder="60" step="1" min="1">
        <div class="form-tips">How often to automatically recalculate and emit target values</div>
    </div>
    <div class="form-row">
        <label for="node-input-decimals"><i class="fa fa-calculator"></i> Decimal Places</label>
        <input type="number" id="node-input-decimals" placeholder="1" step="1" min="0" max="4">
        <div class="form-tips">Number of decimal places to round the output target value (0-4)</div>
    </div>
</script>



<script type="text/html" data-help-name="circadian core">
  <p>
    The <strong>Circadian Core</strong> dynamically computes target values for key vivarium variables 
    (temperature, humidity, light), creating natural circadian and seasonal rhythms based on 
    astronomical calculations and geographic location.
  </p>
  
  <h3>Configuration</h3>
  <ul>
    <li><strong>Location Config:</strong> Reference to a shared location configuration node</li>
    <li><strong>Phase Shift:</strong> Degrees of lead/lag relative to solar cycle (0° = solar noon peak)</li>
    <li><strong>Diurnal Swing:</strong> How much the environment varies between day and night. Forest species need minimal variation (0.3), while desert species experience extreme daily swings (1.6)</li>
    <li><strong>Seasonal Swing:</strong> How much the environment varies between summer and winter. Tropical species need minimal seasonal variation (0.2), while temperate species experience strong seasonal changes (1.6)</li>
    <li><strong>Tick Interval:</strong> How often to automatically recalculate target values (seconds)</li>
    <li><strong>Decimal Places:</strong> Precision of output values (0-4 decimal places)</li>
  </ul>
  
  <h3>Input</h3>
  <p>
    Send numeric values with <code>msg.topic</code> set to:
  </p>
  <ul>
    <li><code>"absoluteMin"</code> or <code>"min"</code> - Minimum value (winter night)</li>
    <li><code>"absoluteMax"</code> or <code>"max"</code> - Maximum value (summer day)</li>
  </ul>
  
  <h3>Outputs</h3>
  <ul>
    <li><strong>Output 1:</strong> Target value - calculated setpoint based on current simulated time</li>
    <li><strong>Output 2:</strong> Status - detailed information including simulated time and time scale</li>
  </ul>
  
  <h3>Habitat-Based Control</h3>
  <p>
    The node combines seasonal and diurnal cycles with configurable amplitudes to match different habitat types:
  </p>
  <ul>
    <li><strong>Forest Floor:</strong> Minimal diurnal swing (0.3), dampened seasonal swing (0.5) - stable microclimate</li>
    <li><strong>Desert:</strong> Extreme diurnal swing (1.6), pronounced seasonal swing (1.3) - harsh daily and seasonal extremes</li>
    <li><strong>Tropical:</strong> Normal diurnal swing (1.0), minimal seasonal swing (0.2) - daily variation but stable seasons</li>
    <li><strong>Temperate:</strong> Normal swings (1.0) for both - typical seasonal and daily patterns</li>
  </ul>
  <p>
    The swing values control the relative influence of daily vs seasonal cycles, automatically normalizing 
    the combined result to interpolate smoothly between your minimum and maximum setpoints.
  </p>
</script>