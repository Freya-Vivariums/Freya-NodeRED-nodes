<script type="text/javascript">
  RED.nodes.registerType('temperature controller',{  
    category: 'Freya Vivariums',
    color: "#A2CA6F",
    defaults: {
      name: {value:""},
      deadband: {value:1.0, required:true, validate:RED.validators.number()},
      minimumTemperature: {value:10.0, required:true, validate:RED.validators.number()},
      maximumTemperature: {value:50.0, required:true, validate:RED.validators.number()},
      watchdogTimeout: {value:60, required:true, validate:RED.validators.number()},
      watchdogSeverity: {value:"warning", required:true}
    },
    inputs:1,
    outputs:2,
    outputLabels:["actuator commands", "status"],
    icon: "font-awesome/fa-thermometer-half",
    label: function() {
      return this.name||"Temperature Controller";
    }
  });
</script>

<script type="text/html" data-template-name="temperature controller">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Temperature Controller">
  </div>
  <hr/>
  <div class="form-row">
    <h3><i class="fa fa-adjust"></i> Control Settings</h3>
  </div>
  <div class="form-row">
    <label for="node-input-deadband">Deadband (°C)</label>
    <input type="number" id="node-input-deadband" placeholder="1.0" step="0.1" min="0.1">
    <i class="fa fa-info-circle" title="Half-width of the deadband around target. With target 25°C and deadband 1.0°C, controller is idle between 24-26°C."></i>
  </div>
  <hr/>
  <div class="form-row">
    <h3><i class="fa fa-shield"></i> Safety Limits</h3>
  </div>
  <div class="form-row">
    <label for="node-input-minimumTemperature">Minimum Temperature (°C)</label>
    <input type="number" id="node-input-minimumTemperature" placeholder="10.0" step="0.1">
    <i class="fa fa-info-circle" title="Absolute safety floor. Force heating if sensor reads below this, regardless of target."></i>
  </div>
  <div class="form-row">
    <label for="node-input-maximumTemperature">Maximum Temperature (°C)</label>
    <input type="number" id="node-input-maximumTemperature" placeholder="50.0" step="0.1">
    <i class="fa fa-info-circle" title="Absolute safety ceiling. Force cooling if sensor reads above this, regardless of target."></i>
  </div>
  <hr/>
  <div class="form-row">
    <h3><i class="fa fa-clock-o"></i> Watchdog Settings</h3>
  </div>
  <div class="form-row">
    <label for="node-input-watchdogTimeout">Watchdog Timeout (seconds)</label>
    <input type="number" id="node-input-watchdogTimeout" placeholder="60" step="1" min="1">
    <i class="fa fa-info-circle" title="Time to wait without sensor updates before entering safe open-loop mode."></i>
  </div>
  <div class="form-row">
    <label for="node-input-watchdogSeverity">Watchdog Severity</label>
    <select id="node-input-watchdogSeverity">
      <option value="warning">Warning</option>
      <option value="error">Error</option>
    </select>
    <i class="fa fa-info-circle" title="Severity level emitted when watchdog triggers. Warning for brief dropouts, Error for critical attention."></i>
  </div>
</script>

<script type="text/html" data-help-name="temperature controller">
  <p>The <b>Temperature Controller</b> node implements bang-bang control with deadband for temperature regulation.</p>
  
  <h3>Input</h3>
  <dl class="message-properties">
    <dt>Target Temperature <span class="property-type">number</span></dt>
    <dd>Target temperature in degrees Celsius from circadian core or other source</dd>
    
    <dt>Sensor Reading <span class="property-type">number</span></dt>
    <dd>Current temperature reading from environment sensor with <code>msg.topic: "sensor"</code> and <code>msg.payload: number</code></dd>
  </dl>
  
  <h3>Outputs</h3>
  <ul>
    <li><strong>Output 1 (Actuators):</strong> <code>msg.payload</code> (object) - actuator commands: <code>{ heater: "on/off", cooler: "on/off" }</code></li>
    <li><strong>Output 2 (Status):</strong> Status information for aggregation</li>
  </ul>
  
  <h3>Control Logic</h3>
  <ul>
    <li><strong>Heating:</strong> When reading &lt; target - deadband</li>
    <li><strong>Cooling:</strong> When reading &gt; target + deadband</li>
    <li><strong>Idle:</strong> When reading within deadband (maintains previous state)</li>
  </ul>
  
  <h3>Safety Overrides</h3>
  <ul>
    <li><strong>Emergency Heating:</strong> Forces heating if reading &lt; minimum temperature</li>
    <li><strong>Emergency Cooling:</strong> Forces cooling if reading &gt; maximum temperature</li>
  </ul>
  
  <h3>Watchdog Protection</h3>
  <ul>
    <li><strong>Sensor Monitoring:</strong> Tracks time since last sensor update</li>
    <li><strong>Open-Loop Mode:</strong> Enters safe state (all actuators off) if no sensor feedback within timeout</li>
    <li><strong>Auto Recovery:</strong> Resumes normal control immediately when sensor returns</li>
    <li><strong>Status Alerts:</strong> Emits configurable severity alerts on watchdog trigger</li>
  </ul>
</script>
