<!--
  Freya Vivarium Control System - Precipitation Controller Node HTML
  Copyright (C) 2025 Sanne 'SpuQ' Santens

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->
<script type="text/javascript">
  RED.nodes.registerType('precipitation controller',{
    category: 'Freya Vivariums',
    color: "#A2CA6F",
    defaults: {
      name: {value:""},
      interval: {value: 60, required: true, validate: RED.validators.number()},
      duration: {value: 30, required: true, validate: RED.validators.number()},
      tickInterval: {value: 60, required: true, validate: function(v) { return RED.validators.number()(v) && parseInt(v) >= 1; }}
    },
    inputs:1,
    outputs:2,
    inputLabels:["parameter update"],
    outputLabels:["control (actuators)", "status"],
    icon: "font-awesome/fa-tint",
    label: function() {
      return this.name || "Precipitation Controller";
    }
  });
</script>

<script type="text/html" data-template-name="precipitation controller">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Precipitation Controller">
  </div>
  <hr/>
  <div class="form-row">
    <label for="node-input-interval"><i class="fa fa-clock-o"></i> Interval (minutes)</label>
    <input type="number" id="node-input-interval" placeholder="60" step="1" min="1">
  </div>
  <div class="form-row">
    <label for="node-input-duration"><i class="fa fa-tint"></i> Duration (seconds)</label>
    <input type="number" id="node-input-duration" placeholder="30" step="1" min="1">
  </div>
  <hr/>
  <div class="form-row">
    <label for="node-input-tickInterval"><i class="fa fa-clock-o"></i> Tick Interval (seconds)</label>
    <input type="number" id="node-input-tickInterval" placeholder="60" step="1" min="1">
  </div>
</script>

<script type="text/html" data-help-name="precipitation controller">
  <p>The <b>Precipitation Controller</b> drives a pump relay on an interval/duration cycle
  for vivarium misting or rain simulation.</p>

  <h3>Input</h3>
  <dl class="message-properties">
    <dt>msg.topic = "interval" <span class="property-type">number</span></dt>
    <dd><code>msg.payload</code> sets the precipitation interval in minutes, overriding the configured default</dd>

    <dt>msg.topic = "duration" <span class="property-type">number</span></dt>
    <dd><code>msg.payload</code> sets the pump duration in seconds, overriding the configured default</dd>

    <dt>msg.topic = "nightDisable" <span class="property-type">boolean</span></dt>
    <dd><code>msg.payload</code> enables (<code>true</code>) or disables (<code>false</code>) the
    nighttime pause feature at runtime. Defaults to <code>false</code> on deploy.
    Switching from <code>true</code> to <code>false</code> while paused resumes normal operation immediately.</dd>

    <dt>msg.topic = "night" <span class="property-type">boolean</span></dt>
    <dd><code>msg.payload</code> signals nighttime (<code>true</code>) or daytime (<code>false</code>).
    Only effective when nighttime disable has been enabled via the <code>nightDisable</code> topic.
    During nighttime no new precipitation events are started. If the pump is already active
    when night begins, the current cycle finishes normally.</dd>
  </dl>
  <p>Messages with unrecognised topics are ignored.</p>

  <h3>Outputs</h3>
  <dl class="message-properties">
    <dt>Output 1: Control <span class="property-type">object</span></dt>
    <dd><code>msg.payload</code> is <code>{ pump: "on" }</code> or <code>{ pump: "off" }</code>
    with <code>msg.topic = "actuators"</code>. Two messages are sent per precipitation event.</dd>

    <dt>Output 2: Status <span class="property-type">object</span></dt>
    <dd><code>msg.payload</code> contains <code>state</code>, <code>timestamp</code>, and optional
    context fields. <code>msg.topic = "status"</code>. Emitted only on state changes.</dd>
  </dl>

  <h3>Details</h3>
  <p>The node runs an autonomous internal tick timer. On each tick it evaluates whether
  precipitation is due:</p>
  <ul>
    <li>If the pump is already running the tick is skipped (no overlapping cycles).</li>
    <li>If nighttime disable is enabled and night is signalled, the tick is skipped.</li>
    <li>If this is the first tick after deploy, or the configured interval has elapsed
        since the last event, the pump is turned on for the configured duration and then
        automatically turned off.</li>
    <li>Otherwise the node updates its status to show the time remaining
        until the next event.</li>
  </ul>
  <p>On redeploy or shutdown the node clears all timers and forces the pump off
  to prevent it from getting stuck on.</p>

  <h3>Nighttime Disable</h3>
  <p>The nighttime disable feature is controlled at runtime via <code>msg.topic = "nightDisable"</code>.
  On deploy it defaults to off (precipitation runs 24/7). When enabled, the node tracks a
  night/day state updated via <code>msg.topic = "night"</code>. During nighttime no new
  precipitation events are started. If the pump is already active when night begins, the
  current cycle is allowed to finish normally. Switching nighttime disable off while paused
  causes the node to resume normal tick evaluation immediately.</p>

  <h3>Status Messages</h3>
  <p>Status messages are emitted on output 2 only when the state changes:</p>
  <ul>
    <li><strong>idle</strong> — initial state after deploy, no evaluation yet</li>
    <li><strong>active</strong> — pump is on (includes <code>duration</code> in ms)</li>
    <li><strong>waiting</strong> — pump off, counting down (includes <code>remaining</code> in ms)</li>
    <li><strong>paused</strong> — nighttime, precipitation suppressed</li>
  </ul>

  <h3>Configuration</h3>
  <ul>
    <li><strong>Interval:</strong> Time between precipitation events in minutes (default: 60)</li>
    <li><strong>Duration:</strong> How long the pump runs per event in seconds (default: 30)</li>
    <li><strong>Tick Interval:</strong> How often to evaluate whether precipitation is due in seconds (default: 60)</li>
  </ul>

  <h3>Node Status</h3>
  <ul>
    <li><strong>idle</strong> (grey/ring) — initial state before first tick</li>
    <li><strong>pump on</strong> (blue/dot) — pump is running, shows duration</li>
    <li><strong>next in …</strong> (green/ring) — waiting, shows time until next event</li>
    <li><strong>last: HH:MM:SS</strong> (grey/ring) — after pump off, shows timestamp</li>
    <li><strong>paused (night)</strong> (grey/ring) — precipitation disabled during nighttime</li>
  </ul>
</script>